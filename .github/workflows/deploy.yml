name: Deploy to Container

on:
  push:
    branches: [mainline]
    paths-ignore:
      - "**.md"

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: dtolnay/rust-toolchain@stable
        with:
      # TODO: Uncomment once the web package is set up
      #   targets: wasm32-unknown-unknown
          components: clippy, rustfmt
    # TODO: Uncomment once the web package is set up
    # - uses: jetli/trunk-action@v0.4.0
      - name: Cache Cargo registry
        uses: actions/cache@v3
        continue-on-error: false
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
      - name: Cache build artifacts
        uses: actions/cache@v3
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-artifacts-${{ hashFiles('**/Cargo.lock') }}
      - name: Lint
        run: cargo fmt -- --check
      - name: Clippy
        run: cargo clippy -- -D warnings --no-deps
      - name: Test
        run: cargo test
      - name: Build
        run: cargo build --release
    # TODO: Uncomment once the web package is set up
    # - name: Webpack
    #   run: trunk build --release website/index.html
    # - name: Upload server binary
    #   uses: actions/upload-artifact@v1
    #   with:
    #     name: release
    #     path: target/release/verity-solver-server
    # - name: Upload WASM
    #   uses: actions/upload-artifact@v1
    #   with:
    #     name: dist
    #     path: website/dist

# TODO: set up deploy action once hosting environment is determined/set up
